import telebot
from telebot import types
import threading
import time
from flask import Flask
from config import BOT_TOKEN, OWNER_ID, RAGHAD_ID, CHANNEL_ID
from utils import is_authorized, get_user_name, get_love_message, calculate_love_duration
from resources import MONTHS_ARABIC, DAYS_ARABIC
from datetime import datetime
import random
import json
import re

bot = telebot.TeleBot(BOT_TOKEN)

# Flask app Ù„Ù„Ù€ keep alive
app = Flask(__name__)

@app.route('/')
def home():
    return "ğŸ¤ Ø¨ÙˆØª Ø´ØºÙ ÙŠØ¹Ù…Ù„ Ø¨Ø­Ø¨!"

def run_flask():
    app.run(host='0.0.0.0', port=8080, debug=False)

# Ø¨Ø¯Ø¡ Flask ÙÙŠ thread Ù…Ù†ÙØµÙ„
flask_thread = threading.Thread(target=run_flask)
flask_thread.daemon = True
flask_thread.start()

# ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø°ÙƒØ±ÙŠØ§Øª Ù…Ø­Ù„ÙŠØ§Ù‹ (Ù…Ø¤Ù‚Øª)
memories_store = []

def save_memory_to_channel(user_id, content, file_id=None, file_type=None):
    """Ø­ÙØ¸ Ø§Ù„Ø°ÙƒØ±Ù‰ ÙÙŠ Ø§Ù„Ù‚Ù†Ø§Ø©"""
    try:
        name = get_user_name(user_id)
        timestamp = datetime.now().strftime('%d/%m/%Y %H:%M')

        channel_text = f"ğŸ’ Ø°ÙƒØ±Ù‰ Ø¬Ø¯ÙŠØ¯Ø© Ù…Ù† {name}:\n\n{content}\n\nğŸ“… {timestamp}"

        # Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„Ù‚Ù†Ø§Ø©
        if file_id and file_type:
            # Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…Ù„Ù Ù…Ø¹ Ø§Ù„Ù†Øµ
            if file_type == 'photo':
                bot.send_photo(CHANNEL_ID, file_id, caption=channel_text)
            elif file_type == 'video':
                bot.send_video(CHANNEL_ID, file_id, caption=channel_text)
            elif file_type == 'document':
                bot.send_document(CHANNEL_ID, file_id, caption=channel_text)
            elif file_type == 'voice':
                bot.send_voice(CHANNEL_ID, file_id, caption=channel_text)
            elif file_type == 'video_note':
                bot.send_video_note(CHANNEL_ID, file_id)
                bot.send_message(CHANNEL_ID, channel_text)
            elif file_type == 'sticker':
                bot.send_sticker(CHANNEL_ID, file_id)
                bot.send_message(CHANNEL_ID, channel_text)
        else:
            bot.send_message(CHANNEL_ID, channel_text)

        # Ø­ÙØ¸ Ù…Ø­Ù„ÙŠØ§Ù‹ Ù„Ù„Ø°ÙƒØ±ÙŠØ§Øª Ø§Ù„Ø¹Ø´ÙˆØ§Ø¦ÙŠØ©
        memories_store.append({
            'user_id': user_id,
            'content': content,
            'timestamp': datetime.now(),
            'name': name,
            'file_id': file_id,
            'file_type': file_type
        })

        return True
    except Exception as e:
        print(f"Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø°ÙƒØ±Ù‰: {e}")
        return False

def get_memories_from_channel():
    """Ø¬Ù„Ø¨ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø°ÙƒØ±ÙŠØ§Øª Ù…Ù† Ø§Ù„Ù‚Ù†Ø§Ø©"""
    try:
        memories = []
        offset = 0
        limit = 100
        
        while True:
            # Ø¬Ù„Ø¨ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ù…Ù† Ø§Ù„Ù‚Ù†Ø§Ø©
            channel_messages = bot.get_chat_history(CHANNEL_ID, offset=offset, limit=limit)
            
            if not channel_messages:
                break
                
            for message in channel_messages:
                # ØªØ­Ù‚Ù‚ Ø¥Ø°Ø§ Ø§Ù„Ø±Ø³Ø§Ù„Ø© ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø°ÙƒØ±Ù‰
                if message.text and "ğŸ’ Ø°ÙƒØ±Ù‰ Ø¬Ø¯ÙŠØ¯Ø© Ù…Ù†" in message.text:
                    # Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ø³Ù… Ø§Ù„Ù…Ø±Ø³Ù„ ÙˆØ§Ù„Ù…Ø­ØªÙˆÙ‰ Ù…Ù† Ø§Ù„Ù†Øµ
                    lines = message.text.split('\n')
                    if len(lines) >= 3:
                        # Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ø³Ù… Ø§Ù„Ù…Ø±Ø³Ù„
                        sender_line = lines[0]
                        if "Ø¹Ù…Ø§Ø± â¤ï¸" in sender_line:
                            user_id = OWNER_ID
                            name = "Ø¹Ù…Ø§Ø± â¤ï¸"
                        elif "Ø±ØºØ¯ ğŸŒ¸" in sender_line:
                            user_id = RAGHAD_ID
                            name = "Ø±ØºØ¯ ğŸŒ¸"
                        else:
                            continue
                        
                        # Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ (ÙƒÙ„ Ø§Ù„Ø£Ø³Ø·Ø± Ù…Ø§ Ø¹Ø¯Ø§ Ø§Ù„Ø£ÙˆÙ„ ÙˆØ§Ù„Ø£Ø®ÙŠØ±)
                        content = '\n'.join(lines[2:-2]) if len(lines) > 3 else lines[1]
                        
                        # Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„ØªØ§Ø±ÙŠØ® Ù…Ù† Ø¢Ø®Ø± Ø³Ø·Ø±
                        date_line = lines[-1]
                        date_match = re.search(r'ğŸ“… (\d{2}/\d{2}/\d{4} \d{2}:\d{2})', date_line)
                        
                        if date_match:
                            try:
                                timestamp = datetime.strptime(date_match.group(1), '%d/%m/%Y %H:%M')
                            except:
                                timestamp = message.date
                        else:
                            timestamp = message.date
                        
                        memories.append({
                            'user_id': user_id,
                            'name': name,
                            'content': content,
                            'timestamp': timestamp,
                            'message_id': message.message_id,
                            'file_id': None,
                            'file_type': None
                        })
                
                # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„ØªÙŠ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ù…Ù„ÙØ§Øª Ù…Ø¹ Ø°ÙƒØ±ÙŠØ§Øª
                elif message.caption and "ğŸ’ Ø°ÙƒØ±Ù‰ Ø¬Ø¯ÙŠØ¯Ø© Ù…Ù†" in message.caption:
                    lines = message.caption.split('\n')
                    if len(lines) >= 3:
                        # Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ø³Ù… Ø§Ù„Ù…Ø±Ø³Ù„
                        sender_line = lines[0]
                        if "Ø¹Ù…Ø§Ø± â¤ï¸" in sender_line:
                            user_id = OWNER_ID
                            name = "Ø¹Ù…Ø§Ø± â¤ï¸"
                        elif "Ø±ØºØ¯ ğŸŒ¸" in sender_line:
                            user_id = RAGHAD_ID
                            name = "Ø±ØºØ¯ ğŸŒ¸"
                        else:
                            continue
                        
                        # Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù…Ø­ØªÙˆÙ‰
                        content = '\n'.join(lines[2:-2]) if len(lines) > 3 else lines[1]
                        
                        # ØªØ­Ø¯ÙŠØ¯ Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù
                        file_id = None
                        file_type = None
                        
                        if message.photo:
                            file_id = message.photo[-1].file_id
                            file_type = 'photo'
                        elif message.video:
                            file_id = message.video.file_id
                            file_type = 'video'
                        elif message.document:
                            file_id = message.document.file_id
                            file_type = 'document'
                        elif message.voice:
                            file_id = message.voice.file_id
                            file_type = 'voice'
                        elif message.video_note:
                            file_id = message.video_note.file_id
                            file_type = 'video_note'
                        elif message.sticker:
                            file_id = message.sticker.file_id
                            file_type = 'sticker'
                        
                        # Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„ØªØ§Ø±ÙŠØ®
                        date_line = lines[-1]
                        date_match = re.search(r'ğŸ“… (\d{2}/\d{2}/\d{4} \d{2}:\d{2})', date_line)
                        
                        if date_match:
                            try:
                                timestamp = datetime.strptime(date_match.group(1), '%d/%m/%Y %H:%M')
                            except:
                                timestamp = message.date
                        else:
                            timestamp = message.date
                        
                        memories.append({
                            'user_id': user_id,
                            'name': name,
                            'content': content,
                            'timestamp': timestamp,
                            'message_id': message.message_id,
                            'file_id': file_id,
                            'file_type': file_type
                        })
            
            offset += limit
            
            # Ø¥Ø°Ø§ Ø¬Ø¨Ù†Ø§ Ø£Ù‚Ù„ Ù…Ù† Ø§Ù„Ø­Ø¯ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ØŒ Ù…Ø¹Ù†Ø§ØªÙ‡ Ø®Ù„ØµØª Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
            if len(channel_messages) < limit:
                break
        
        return memories
        
    except Exception as e:
        print(f"Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø°ÙƒØ±ÙŠØ§Øª Ù…Ù† Ø§Ù„Ù‚Ù†Ø§Ø©: {e}")
        return []

def get_random_memory_from_channel(user_id):
    """Ø¬Ù„Ø¨ Ø°ÙƒØ±Ù‰ Ø¹Ø´ÙˆØ§Ø¦ÙŠØ© Ù…Ù† Ø§Ù„Ù‚Ù†Ø§Ø©"""
    try:
        all_memories = get_memories_from_channel()
        user_memories = [m for m in all_memories if m['user_id'] == user_id]
        
        if not user_memories:
            return None
        
        # ØªØ±ØªÙŠØ¨ Ø§Ù„Ø°ÙƒØ±ÙŠØ§Øª Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ®
        user_memories.sort(key=lambda x: x['timestamp'])
        
        # Ø§Ø®ØªÙŠØ§Ø± Ø°ÙƒØ±Ù‰ Ø¹Ø´ÙˆØ§Ø¦ÙŠØ©
        selected_memory = random.choice(user_memories)
        
        # Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©
        selected_memory['formatted_date'] = selected_memory['timestamp'].strftime("%d/%m/%Y Ø§Ù„Ø³Ø§Ø¹Ø© %H:%M")
        selected_memory['day_name'] = selected_memory['timestamp'].strftime("%A")
        
        # ØªØ±Ø¬Ù…Ø© Ø§Ø³Ù… Ø§Ù„ÙŠÙˆÙ… Ù„Ù„Ø¹Ø±Ø¨ÙŠØ©
        days_translation = {
            'Monday': 'Ø§Ù„Ø§Ø«Ù†ÙŠÙ†',
            'Tuesday': 'Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡', 
            'Wednesday': 'Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡',
            'Thursday': 'Ø§Ù„Ø®Ù…ÙŠØ³',
            'Friday': 'Ø§Ù„Ø¬Ù…Ø¹Ø©',
            'Saturday': 'Ø§Ù„Ø³Ø¨Øª',
            'Sunday': 'Ø§Ù„Ø£Ø­Ø¯'
        }
        
        selected_memory['day_name_arabic'] = days_translation.get(selected_memory['day_name'], selected_memory['day_name'])
        selected_memory['total_memories'] = len(user_memories)
        selected_memory['memory_index'] = user_memories.index(selected_memory) + 1
        
        return selected_memory
        
    except Exception as e:
        print(f"Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø°ÙƒØ±Ù‰ Ø¹Ø´ÙˆØ§Ø¦ÙŠØ©: {e}")
        return None

def create_main_keyboard():
    markup = types.InlineKeyboardMarkup(row_width=2)
    btn1 = types.InlineKeyboardButton("ğŸ’ Ø¥Ø¶Ø§ÙØ© Ø°ÙƒØ±Ù‰ Ø¬Ø¯ÙŠØ¯Ø©", callback_data="add_memory")
    btn2 = types.InlineKeyboardButton("ğŸ Ø°ÙƒØ±Ù‰ Ø¹Ø´ÙˆØ§Ø¦ÙŠØ©", callback_data="random_memory")
    btn3 = types.InlineKeyboardButton("ğŸ’• Ø°ÙƒØ±Ù‰ Ø­Ø¨Ù†Ø§", callback_data="love_memory")
    btn4 = types.InlineKeyboardButton("â° Ø¹Ø¯Ø§Ø¯ Ø­Ø¨Ù†Ø§", callback_data="love_counter")
    btn5 = types.InlineKeyboardButton("ğŸŒŸ Ù…ÙØ§Ø¬Ø£Ø© Ø­Ø¨", callback_data="love_surprise")

    markup.add(btn1, btn2)
    markup.add(btn3, btn4)
    markup.add(btn5)
    return markup

def create_start_keyboard():
    """Ø¥Ù†Ø´Ø§Ø¡ ÙƒÙŠØ¨ÙˆØ±Ø¯ Ø¹Ø§Ø¯ÙŠ Ù„Ø²Ø± Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©"""
    markup = types.ReplyKeyboardMarkup(resize_keyboard=True, one_time_keyboard=False)
    btn = types.KeyboardButton("Ø¨Ø­Ø¨Ùƒ â¤ï¸")
    markup.add(btn)
    return markup

@bot.message_handler(commands=['start'])
def start(message):
    user_id = message.from_user.id

    if not is_authorized(user_id):
        bot.send_message(message.chat.id, "ğŸš« Ù‡Ø°Ø§ Ø§Ù„Ø¨ÙˆØª Ø®Ø§Øµ Ø¨Ø¹Ù…Ø§Ø± ÙˆØ±ØºØ¯ ÙÙ‚Ø·.")
        return

    name = get_user_name(user_id)
    love_msg = get_love_message(user_id)

    welcome_text = f"Ø£Ù‡Ù„Ù‹Ø§ ÙˆØ³Ù‡Ù„Ù‹Ø§ {name}! ğŸ¤\n\n"
    welcome_text += "ğŸ’« Ù…Ø±Ø­Ø¨Ù‹Ø§ Ø¨Ùƒ ÙÙŠ Ø¨ÙˆØª Ø´ØºÙ Ø§Ù„Ù…Ø·ÙˆØ± Ø®ØµÙŠØµÙ‹Ø§ Ù„Ø­ÙØ¸ Ø°ÙƒØ±ÙŠØ§ØªÙƒÙ… Ø§Ù„Ø­Ù„ÙˆØ©\n\n"
    welcome_text += f"{love_msg}\n\n"
    welcome_text += "Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± 'Ø¨Ø­Ø¨Ùƒ â¤ï¸' Ø£Ùˆ Ø§Ø®ØªØ± Ù…Ù† Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø£Ø¯Ù†Ø§Ù‡ â¬‡ï¸"

    bot.send_message(message.chat.id, welcome_text, 
                    reply_markup=create_start_keyboard())
    bot.send_message(message.chat.id, "ğŸ’ Ø§Ø®ØªØ± Ù…Ø§ ØªØ±ÙŠØ¯ Ø¹Ù…Ù„Ù‡:", 
                    reply_markup=create_main_keyboard())

@bot.message_handler(func=lambda message: message.text == "Ø¨Ø­Ø¨Ùƒ â¤ï¸")
def love_button_handler(message):
    user_id = message.from_user.id

    if not is_authorized(user_id):
        return

    name = get_user_name(user_id)
    love_msg = get_love_message(user_id, surprise=True)

    response_text = f"ğŸ’• ÙˆØ§Ù†Ø§ ÙƒÙ…Ø§Ù† Ø¨Ø­Ø¨Ùƒ {name}! ğŸŒ¸\n\n{love_msg}"

    bot.send_message(message.chat.id, response_text, reply_markup=create_main_keyboard())

@bot.callback_query_handler(func=lambda call: True)
def handle_callback(call):
    user_id = call.from_user.id

    if not is_authorized(user_id):
        try:
            bot.answer_callback_query(call.id, "âŒ ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­ Ù„Ùƒ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù‡Ø°Ø§ Ø§Ù„Ø¨ÙˆØª")
        except:
            pass
        return

    try:
        if call.data == "add_memory":
            try:
                bot.answer_callback_query(call.id, "ğŸ’ Ø£Ø±Ø³Ù„ Ø°ÙƒØ±ØªÙƒ Ø§Ù„Ø¢Ù†")
            except:
                pass
            memory_markup = types.InlineKeyboardMarkup()
            text_btn = types.InlineKeyboardButton("ğŸ“ Ù†Øµ Ø¹Ø§Ø¯ÙŠ", callback_data="memory_text")
            caption_btn = types.InlineKeyboardButton("ğŸ·ï¸ Ù…Ø¹ Ù†Øµ ØªÙˆØ¶ÙŠØ­ÙŠ", callback_data="memory_caption")
            back_btn = types.InlineKeyboardButton("ğŸ”™ Ø±Ø¬ÙˆØ¹", callback_data="back_main")
            memory_markup.add(text_btn, caption_btn)
            memory_markup.add(back_btn)
            
            try:
                bot.delete_message(call.message.chat.id, call.message.message_id)
            except:
                pass
            bot.send_message(call.message.chat.id, "ğŸ’ ÙƒÙŠÙ Ø¨Ø¯Ùƒ ØªØ­ÙØ¸ Ø§Ù„Ø°ÙƒØ±Ù‰ØŸ", reply_markup=memory_markup)

        elif call.data == "memory_text":
            try:
                bot.answer_callback_query(call.id, "ğŸ’ Ø£Ø±Ø³Ù„ Ø°ÙƒØ±ØªÙƒ Ø§Ù„Ø¢Ù†")
            except:
                pass
            bot.send_message(call.message.chat.id, "ğŸ’ Ø§ÙƒØªØ¨ Ø§Ù„Ø°ÙƒØ±Ù‰ Ø§Ù„Ø­Ù„ÙˆØ© Ø§Ù„Ù„ÙŠ Ø¨Ø¯Ùƒ ØªØ­ÙØ¸Ù‡Ø§:")
            bot.register_next_step_handler(call.message, save_memory)

        elif call.data == "memory_caption":
            try:
                bot.answer_callback_query(call.id, "ğŸ·ï¸ Ø£Ø±Ø³Ù„ Ø§Ù„Ù…Ù„Ù Ù…Ø¹ Ù†Øµ ØªÙˆØ¶ÙŠØ­ÙŠ")
            except:
                pass
            bot.send_message(call.message.chat.id, "ğŸ·ï¸ Ø£Ø±Ø³Ù„ Ø§Ù„ØµÙˆØ±Ø© Ø£Ùˆ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø£Ùˆ Ø§Ù„Ù…Ù„Ù Ù…Ø¹ Ø§Ù„Ù†Øµ Ø§Ù„ØªÙˆØ¶ÙŠØ­ÙŠ ÙÙŠ Ø®Ø§Ù†Ø© Caption:")
            bot.register_next_step_handler(call.message, save_memory)

        elif call.data == "random_memory":
            try:
                bot.answer_callback_query(call.id, "ğŸ” Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø°ÙƒØ±ÙŠØ§Øª...")
            except:
                pass
                
            memory = get_random_memory_from_channel(user_id)
            if memory:
                # ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù†Øµ Ù…Ø¹ ØªÙØ§ØµÙŠÙ„ Ù…Ù†Ø¸Ù…Ø©
                name = memory['name']
                content = memory['content']
                formatted_date = memory['formatted_date']
                day_name = memory['day_name_arabic']
                
                text = f"ğŸ Ø°ÙƒØ±Ù‰ Ø¹Ø´ÙˆØ§Ø¦ÙŠØ© Ø­Ù„ÙˆØ© Ù…Ù† {name}:\n\n"
                text += f"ğŸ’« {content}\n\n"
                text += f"ğŸ“… {formatted_date}\n"
                text += f"ğŸ—“ï¸ ÙŠÙˆÙ… {day_name}\n\n"
                text += f"âœ¨ Ø°ÙƒØ±Ù‰ Ø±Ù‚Ù… {memory['memory_index']} Ù…Ù† Ø£ØµÙ„ {memory['total_memories']} Ø°ÙƒØ±Ù‰ Ù…Ø­ÙÙˆØ¸Ø©"

                random_markup = types.InlineKeyboardMarkup()
                again_btn = types.InlineKeyboardButton("ğŸ”„ Ø°ÙƒØ±Ù‰ Ø£Ø®Ø±Ù‰", callback_data="random_memory")
                back_btn = types.InlineKeyboardButton("ğŸ”™ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©", callback_data="back_main")
                random_markup.add(again_btn)
                random_markup.add(back_btn)

                # Ø­Ø°Ù Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ø£ÙˆÙ„Ø§Ù‹
                try:
                    bot.delete_message(call.message.chat.id, call.message.message_id)
                except:
                    pass

                # Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø°ÙƒØ±Ù‰ Ø­Ø³Ø¨ Ù†ÙˆØ¹Ù‡Ø§
                if memory.get('file_id') and memory.get('file_type'):
                    file_id = memory['file_id']
                    file_type = memory['file_type']
                    
                    try:
                        # Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…Ù„Ù Ù…Ø¹ Ø§Ù„Ù†Øµ
                        if file_type == 'photo':
                            bot.send_photo(call.message.chat.id, file_id, caption=text, reply_markup=random_markup)
                        elif file_type == 'video':
                            bot.send_video(call.message.chat.id, file_id, caption=text, reply_markup=random_markup)
                        elif file_type == 'document':
                            bot.send_document(call.message.chat.id, file_id, caption=text, reply_markup=random_markup)
                        elif file_type == 'voice':
                            bot.send_voice(call.message.chat.id, file_id, caption=text, reply_markup=random_markup)
                        elif file_type == 'video_note':
                            bot.send_video_note(call.message.chat.id, file_id)
                            bot.send_message(call.message.chat.id, text, reply_markup=random_markup)
                        elif file_type == 'sticker':
                            bot.send_sticker(call.message.chat.id, file_id)
                            bot.send_message(call.message.chat.id, text, reply_markup=random_markup)
                    except Exception as e:
                        # Ø¥Ø°Ø§ Ø§Ù„Ù…Ù„Ù Ù…Ø´ Ù…ØªØ§Ø­ØŒ Ø£Ø±Ø³Ù„ Ø§Ù„Ù†Øµ Ø¨Ø³
                        bot.send_message(call.message.chat.id, text, reply_markup=random_markup)
                else:
                    # Ø°ÙƒØ±Ù‰ Ù†ØµÙŠØ© Ø¹Ø§Ø¯ÙŠØ©
                    bot.send_message(call.message.chat.id, text, reply_markup=random_markup)
            else:
                try:
                    bot.answer_callback_query(call.id, "ğŸ“­ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø°ÙƒØ±ÙŠØ§Øª Ù…Ø­ÙÙˆØ¸Ø© Ø¨Ø¹Ø¯")
                except:
                    pass
                bot.send_message(call.message.chat.id, "ğŸ“­ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø°ÙƒØ±ÙŠØ§Øª Ù…Ø­ÙÙˆØ¸Ø© Ø¨Ø¹Ø¯ ÙÙŠ Ø§Ù„Ù‚Ù†Ø§Ø©", reply_markup=create_main_keyboard())

        elif call.data == "love_memory":
            love_text = "ğŸ’• Ø°ÙƒØ±Ù‰ Ø­Ø¨Ù†Ø§ Ø§Ù„Ø®Ø§ØµØ© ğŸ’•\n\n"
            love_text += "ğŸ“… 6 ØªÙ…ÙˆØ² 2025\n"
            love_text += "ğŸ’« Ø¨Ø¯Ø§ÙŠØ© Ù‚ØµØ© Ø­Ø¨Ù†Ø§ Ø§Ù„Ø­Ù„ÙˆØ©\n\n"
            love_text += "ğŸŒ¸ Ù‡Ø§ÙŠ Ø£Ø­Ù„Ù‰ Ø°ÙƒØ±Ù‰ Ø¨Ø­ÙŠØ§ØªÙ†Ø§ØŒ ÙŠÙˆÙ… Ø§Ù„Ù„ÙŠ Ù‚Ø±Ø±Ù†Ø§ Ù†ÙƒÙˆÙ† Ø³ÙˆØ§ Ù„Ù„Ø£Ø¨Ø¯ ğŸ’•\n"
            love_text += "ğŸ¤ ÙƒÙ„ ÙŠÙˆÙ… Ø¨Ù…Ø± Ø¨ÙŠØ²ÙŠØ¯ Ø­Ø¨Ù†Ø§ Ø£ÙƒØªØ± ÙˆØ£ÙƒØªØ±"

            love_markup = types.InlineKeyboardMarkup()
            back_btn = types.InlineKeyboardButton("ğŸ”™ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©", callback_data="back_main")
            love_markup.add(back_btn)

            try:
                bot.delete_message(call.message.chat.id, call.message.message_id)
            except:
                pass
            bot.send_message(call.message.chat.id, love_text, reply_markup=love_markup)

        elif call.data == "love_counter":
            duration_text = calculate_love_duration()

            counter_markup = types.InlineKeyboardMarkup()
            refresh_btn = types.InlineKeyboardButton("ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯", callback_data="love_counter")
            back_btn = types.InlineKeyboardButton("ğŸ”™ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©", callback_data="back_main")
            counter_markup.add(refresh_btn)
            counter_markup.add(back_btn)

            try:
                bot.delete_message(call.message.chat.id, call.message.message_id)
            except:
                pass
            bot.send_message(call.message.chat.id, duration_text, reply_markup=counter_markup)

        elif call.data == "love_surprise":
            name = get_user_name(user_id)
            surprise_msg = get_love_message(user_id, surprise=True)

            surprise_text = f"ğŸŒŸ Ù…ÙØ§Ø¬Ø£Ø© Ø­Ø¨ Ø®Ø§ØµØ© Ù„Ù€ {name} ğŸŒŸ\n\n{surprise_msg}"

            surprise_markup = types.InlineKeyboardMarkup()
            again_btn = types.InlineKeyboardButton("ğŸ’• Ù…ÙØ§Ø¬Ø£Ø© Ø£Ø®Ø±Ù‰", callback_data="love_surprise")
            back_btn = types.InlineKeyboardButton("ğŸ”™ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©", callback_data="back_main")
            surprise_markup.add(again_btn)
            surprise_markup.add(back_btn)

            try:
                bot.delete_message(call.message.chat.id, call.message.message_id)
            except:
                pass
            bot.send_message(call.message.chat.id, surprise_text, reply_markup=surprise_markup)

        elif call.data == "back_main":
            name = get_user_name(user_id)
            love_msg = get_love_message(user_id)

            main_text = f"ğŸ¤ Ø£Ù‡Ù„Ù‹Ø§ {name}!\n\n{love_msg}\n\nØ§Ø®ØªØ± Ù…Ø§ ØªØ±ÙŠØ¯ Ø¹Ù…Ù„Ù‡:"

            try:
                bot.delete_message(call.message.chat.id, call.message.message_id)
            except:
                pass
            bot.send_message(call.message.chat.id, main_text, reply_markup=create_main_keyboard())

        try:
            bot.answer_callback_query(call.id)
        except:
            pass

    except Exception as e:
        print(f"Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø§Ø³ØªØ¯Ø¹Ø§Ø¡: {e}")
        try:
            bot.answer_callback_query(call.id, "âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰")
        except:
            pass



def save_memory(message):
    user_id = message.from_user.id
    
    # ØªØ­Ø¯ÙŠØ¯ Ù†ÙˆØ¹ Ø§Ù„Ù…Ø­ØªÙˆÙ‰
    content = ""
    file_id = None
    file_type = None
    
    if message.text:
        content = message.text
    elif message.photo:
        content = message.caption or "ğŸ“¸ ØµÙˆØ±Ø© Ø­Ù„ÙˆØ©"
        file_id = message.photo[-1].file_id
        file_type = 'photo'
    elif message.video:
        content = message.caption or "ğŸ¥ ÙÙŠØ¯ÙŠÙˆ Ø±Ø§Ø¦Ø¹"
        file_id = message.video.file_id
        file_type = 'video'
    elif message.document:
        content = message.caption or f"ğŸ“„ Ù…Ù„Ù: {message.document.file_name or 'Ù…Ù„Ù'}"
        file_id = message.document.file_id
        file_type = 'document'
    elif message.voice:
        content = "ğŸ¤ Ø±Ø³Ø§Ù„Ø© ØµÙˆØªÙŠØ© Ø­Ù„ÙˆØ©"
        file_id = message.voice.file_id
        file_type = 'voice'
    elif message.video_note:
        content = "â­• ÙÙŠØ¯ÙŠÙˆ Ø¯Ø§Ø¦Ø±ÙŠ Ø±Ø§Ø¦Ø¹"
        file_id = message.video_note.file_id
        file_type = 'video_note'
    elif message.sticker:
        content = "ğŸ˜Š Ù…Ù„ØµÙ‚ Ø¬Ù…ÙŠÙ„"
        file_id = message.sticker.file_id
        file_type = 'sticker'
    else:
        content = "ğŸ’« Ø°ÙƒØ±Ù‰ Ø®Ø§ØµØ©"

    try:
        if save_memory_to_channel(user_id, content, file_id, file_type):
            success_text = "âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø°ÙƒØ±Ù‰ ÙÙŠ Ø§Ù„Ù‚Ù†Ø§Ø© Ø¨Ù†Ø¬Ø§Ø­! ğŸ’•\n\nØ¨Ø¯Ùƒ ØªØ¹Ù…Ù„ Ø´ÙŠ ØªØ§Ù†ÙŠØŸ"
            bot.send_message(message.chat.id, success_text, reply_markup=create_main_keyboard())
        else:
            bot.send_message(message.chat.id, "âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø°ÙƒØ±Ù‰ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰")

    except Exception as e:
        bot.send_message(message.chat.id, "âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø°ÙƒØ±Ù‰ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰")

# Ù…Ø¹Ø§Ù„Ø¬ Ù„Ù„ØµÙˆØ±
@bot.message_handler(content_types=['photo'])
def handle_photo(message):
    user_id = message.from_user.id
    
    if not is_authorized(user_id):
        bot.send_message(message.chat.id, "ğŸš« Ù‡Ø°Ø§ Ø§Ù„Ø¨ÙˆØª Ø®Ø§Øµ Ø¨Ø¹Ù…Ø§Ø± ÙˆØ±ØºØ¯ ÙÙ‚Ø·.")
        return
    
    content = message.caption or "ğŸ“¸ ØµÙˆØ±Ø© Ø­Ù„ÙˆØ© Ù…Ù† Ø°ÙƒØ±ÙŠØ§ØªÙ†Ø§"
    file_id = message.photo[-1].file_id
    
    try:
        if save_memory_to_channel(user_id, content, file_id, 'photo'):
            response_text = "ğŸ“¸ ØªÙ… Ø­ÙØ¸ Ø§Ù„ØµÙˆØ±Ø© ÙƒØ°ÙƒØ±Ù‰ Ø­Ù„ÙˆØ© ÙÙŠ Ø§Ù„Ù‚Ù†Ø§Ø©! ğŸ’•\n\nØ¨Ø¯Ùƒ ØªØ¹Ù…Ù„ Ø´ÙŠ ØªØ§Ù†ÙŠØŸ"
            bot.send_message(message.chat.id, response_text, reply_markup=create_main_keyboard())
        else:
            bot.send_message(message.chat.id, "âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰")
    except Exception as e:
        bot.send_message(message.chat.id, "âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰")

# Ù…Ø¹Ø§Ù„Ø¬ Ù„Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª
@bot.message_handler(content_types=['video'])
def handle_video(message):
    user_id = message.from_user.id
    
    if not is_authorized(user_id):
        bot.send_message(message.chat.id, "ğŸš« Ù‡Ø°Ø§ Ø§Ù„Ø¨ÙˆØª Ø®Ø§Øµ Ø¨Ø¹Ù…Ø§Ø± ÙˆØ±ØºØ¯ ÙÙ‚Ø·.")
        return
    
    content = message.caption or "ğŸ¥ ÙÙŠØ¯ÙŠÙˆ Ø±Ø§Ø¦Ø¹ Ù…Ù† Ø°ÙƒØ±ÙŠØ§ØªÙ†Ø§"
    file_id = message.video.file_id
    
    try:
        if save_memory_to_channel(user_id, content, file_id, 'video'):
            response_text = "ğŸ¥ ØªÙ… Ø­ÙØ¸ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ÙƒØ°ÙƒØ±Ù‰ Ø­Ù„ÙˆØ© ÙÙŠ Ø§Ù„Ù‚Ù†Ø§Ø©! ğŸ’•\n\nØ¨Ø¯Ùƒ ØªØ¹Ù…Ù„ Ø´ÙŠ ØªØ§Ù†ÙŠØŸ"
            bot.send_message(message.chat.id, response_text, reply_markup=create_main_keyboard())
        else:
            bot.send_message(message.chat.id, "âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰")
    except Exception as e:
        bot.send_message(message.chat.id, "âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰")

# Ù…Ø¹Ø§Ù„Ø¬ Ù„Ù„Ù…Ù„ÙØ§Øª
@bot.message_handler(content_types=['document'])
def handle_document(message):
    user_id = message.from_user.id
    
    if not is_authorized(user_id):
        bot.send_message(message.chat.id, "ğŸš« Ù‡Ø°Ø§ Ø§Ù„Ø¨ÙˆØª Ø®Ø§Øµ Ø¨Ø¹Ù…Ø§Ø± ÙˆØ±ØºØ¯ ÙÙ‚Ø·.")
        return
    
    content = message.caption or f"ğŸ“„ Ù…Ù„Ù: {message.document.file_name or 'Ù…Ù„Ù Ù…Ù‡Ù…'}"
    file_id = message.document.file_id
    
    try:
        if save_memory_to_channel(user_id, content, file_id, 'document'):
            response_text = "ğŸ“„ ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ù ÙƒØ°ÙƒØ±Ù‰ ÙÙŠ Ø§Ù„Ù‚Ù†Ø§Ø©! ğŸ’•\n\nØ¨Ø¯Ùƒ ØªØ¹Ù…Ù„ Ø´ÙŠ ØªØ§Ù†ÙŠØŸ"
            bot.send_message(message.chat.id, response_text, reply_markup=create_main_keyboard())
        else:
            bot.send_message(message.chat.id, "âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰")
    except Exception as e:
        bot.send_message(message.chat.id, "âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰")

# Ù…Ø¹Ø§Ù„Ø¬ Ù„Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„ØµÙˆØªÙŠØ©
@bot.message_handler(content_types=['voice'])
def handle_voice(message):
    user_id = message.from_user.id
    
    if not is_authorized(user_id):
        bot.send_message(message.chat.id, "ğŸš« Ù‡Ø°Ø§ Ø§Ù„Ø¨ÙˆØª Ø®Ø§Øµ Ø¨Ø¹Ù…Ø§Ø± ÙˆØ±ØºØ¯ ÙÙ‚Ø·.")
        return
    
    content = "ğŸ¤ Ø±Ø³Ø§Ù„Ø© ØµÙˆØªÙŠØ© Ø­Ù„ÙˆØ©"
    file_id = message.voice.file_id
    
    try:
        if save_memory_to_channel(user_id, content, file_id, 'voice'):
            response_text = "ğŸ¤ ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØµÙˆØªÙŠØ© ÙƒØ°ÙƒØ±Ù‰ ÙÙŠ Ø§Ù„Ù‚Ù†Ø§Ø©! ğŸ’•\n\nØ¨Ø¯Ùƒ ØªØ¹Ù…Ù„ Ø´ÙŠ ØªØ§Ù†ÙŠØŸ"
            bot.send_message(message.chat.id, response_text, reply_markup=create_main_keyboard())
        else:
            bot.send_message(message.chat.id, "âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰")
    except Exception as e:
        bot.send_message(message.chat.id, "âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰")

# Ù…Ø¹Ø§Ù„Ø¬ Ù„Ù„Ù…Ù„ØµÙ‚Ø§Øª
@bot.message_handler(content_types=['sticker'])
def handle_sticker(message):
    user_id = message.from_user.id
    
    if not is_authorized(user_id):
        bot.send_message(message.chat.id, "ğŸš« Ù‡Ø°Ø§ Ø§Ù„Ø¨ÙˆØª Ø®Ø§Øµ Ø¨Ø¹Ù…Ø§Ø± ÙˆØ±ØºØ¯ ÙÙ‚Ø·.")
        return
    
    content = "ğŸ˜Š Ù…Ù„ØµÙ‚ Ø¬Ù…ÙŠÙ„"
    file_id = message.sticker.file_id
    
    try:
        if save_memory_to_channel(user_id, content, file_id, 'sticker'):
            response_text = "ğŸ˜Š ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ù„ØµÙ‚ ÙƒØ°ÙƒØ±Ù‰ ÙÙŠ Ø§Ù„Ù‚Ù†Ø§Ø©! ğŸ’•\n\nØ¨Ø¯Ùƒ ØªØ¹Ù…Ù„ Ø´ÙŠ ØªØ§Ù†ÙŠØŸ"
            bot.send_message(message.chat.id, response_text, reply_markup=create_main_keyboard())
        else:
            bot.send_message(message.chat.id, "âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰")
    except Exception as e:
        bot.send_message(message.chat.id, "âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰")

# Ù…Ø¹Ø§Ù„Ø¬ Ù„Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù†ØµÙŠØ© Ø§Ù„Ø¹Ø§Ø¯ÙŠØ©
@bot.message_handler(func=lambda message: True)
def handle_message(message):
    user_id = message.from_user.id

    if not is_authorized(user_id):
        bot.send_message(message.chat.id, "ğŸš« Ù‡Ø°Ø§ Ø§Ù„Ø¨ÙˆØª Ø®Ø§Øµ Ø¨Ø¹Ù…Ø§Ø± ÙˆØ±ØºØ¯ ÙÙ‚Ø·.")
        return

    # Ø­ÙØ¸ Ø§Ù„Ø±Ø³Ø§Ù„Ø© ÙƒØ°ÙƒØ±Ù‰ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ ÙÙŠ Ø§Ù„Ù‚Ù†Ø§Ø©
    content = message.text

    try:
        if save_memory_to_channel(user_id, content):
            response_text = "ğŸ’« ØªÙ… Ø­ÙØ¸ Ø±Ø³Ø§Ù„ØªÙƒ ÙƒØ°ÙƒØ±Ù‰ Ø­Ù„ÙˆØ© ÙÙŠ Ø§Ù„Ù‚Ù†Ø§Ø©!\n\nØ¨Ø¯Ùƒ ØªØ¹Ù…Ù„ Ø´ÙŠ ØªØ§Ù†ÙŠØŸ"
            bot.send_message(message.chat.id, response_text, reply_markup=create_main_keyboard())
        else:
            bot.send_message(message.chat.id, "âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰")

    except Exception as e:
        bot.send_message(message.chat.id, "âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰")

if __name__ == "__main__":
    print("ğŸ¤ Ø¨ÙˆØª Ø´ØºÙ Ø¨Ø¯Ø£ Ø§Ù„Ø¹Ù…Ù„...")
    bot.infinity_polling(none_stop=True, interval=0)
